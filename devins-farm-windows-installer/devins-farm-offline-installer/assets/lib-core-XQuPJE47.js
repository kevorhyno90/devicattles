const h="devinsfarm:auth",S="devinsfarm:users",v={MANAGER:{name:"Farm Manager",permissions:["read","write","delete","manage_users","view_financials"]},WORKER:{name:"Farm Worker",permissions:["read","write"]},VETERINARIAN:{name:"Veterinarian",permissions:["read","write","view_health"]},VIEWER:{name:"Viewer",permissions:["read"]}},E=[{id:"user-001",username:"admin",password:"admin123",name:"Farm Administrator",role:"MANAGER",email:"admin@devinsfarm.com",createdAt:new Date().toISOString()},{id:"user-002",username:"worker",password:"worker123",name:"John Worker",role:"WORKER",email:"worker@devinsfarm.com",createdAt:new Date().toISOString()},{id:"user-003",username:"vet",password:"vet123",name:"Dr. Sarah Wilson",role:"VETERINARIAN",email:"vet@devinsfarm.com",createdAt:new Date().toISOString()}];function A(){localStorage.getItem(S)||localStorage.setItem(S,JSON.stringify(E))}function M(){A();const e=localStorage.getItem(S);return e?JSON.parse(e):E}function H(e,t){A();const r=M().find(s=>s.username===e&&s.password===t);if(!r)return{success:!1,error:"Invalid username or password"};const o={userId:r.id,username:r.username,name:r.name,role:r.role,email:r.email,loginTime:new Date().toISOString(),lastActivity:new Date().toISOString()};return localStorage.setItem(h,JSON.stringify(o)),{success:!0,user:o}}function J(){return localStorage.removeItem(h),{success:!0}}function w(){const e=localStorage.getItem(h);if(!e)return null;const t=JSON.parse(e);return t.lastActivity=new Date().toISOString(),localStorage.setItem(h,JSON.stringify(t)),t}function L(){return w()!==null}function j(e){const t=w();if(!t)return!1;const n=v[t.role];return n&&n.permissions.includes(e)}function G(){const e=w();return e?e.name:"Guest"}function K(){const e=w();if(!e)return"Guest";const t=v[e.role];return t?t.name:e.role}typeof window<"u"&&A();const x="devinsfarm",F=1,b={animals:"animals",transactions:"transactions",inventory:"inventory",equipment:"equipment",tasks:"tasks",crops:"crops",treatments:"treatments",measurements:"measurements",breeding:"breeding",milkYield:"milkYield",diets:"diets",rations:"rations"};let y=null;async function R(){return y||(window.indexedDB?new Promise((e,t)=>{const n=indexedDB.open(x,F);n.onerror=()=>{console.error("IndexedDB error:",n.error),e(null)},n.onsuccess=()=>{y=n.result,e(y)},n.onupgradeneeded=r=>{const o=r.target.result;Object.values(b).forEach(s=>{o.objectStoreNames.contains(s)||o.createObjectStore(s,{keyPath:"id"})})}}):(console.warn("IndexedDB not available, falling back to localStorage"),null))}function m(e,t=[]){try{return O(e,t)}catch(n){return console.error("Load failed:",n),t}}function O(e,t=[]){try{const n=`cattalytics:${e}`,r=localStorage.getItem(n);if(!r)return t;const o=JSON.parse(r);return Array.isArray(t)&&!Array.isArray(o)?(console.warn(`Expected array for ${e}, got ${typeof o}. Returning default.`),t):o}catch(n){return console.error("Failed to load from localStorage:",e,n),t}}typeof window<"u"&&R().catch(e=>{console.warn("IndexedDB initialization failed:",e)});function P(){try{const e=m("animals",[]);if(!Array.isArray(e))return console.warn("Animals data is not an array:",typeof e),{total:0,byType:{},byStatus:{}};const t=e.filter(r=>r.status!=="Sold"&&r.status!=="Deceased"),n={};return t.forEach(r=>{const o=r.type||"Unknown";n[o]=(n[o]||0)+1}),{total:t.length,byType:n,byStatus:C(t)}}catch(e){return console.error("Error calculating animals by type:",e),{total:0,byType:{},byStatus:{}}}}function C(e){const t={};return e.forEach(n=>{const r=n.status||"Active";t[r]=(t[r]||0)+1}),t}function N(){try{const e=m("breeding",[]);if(!Array.isArray(e))return console.warn("Breeding data is not an array:",typeof e),{totalPregnant:0,dueNextMonth:0,overdue:0,successRate:0};const t=new Date,n=e.filter(s=>s.status==="Pregnant"||s.status==="Confirmed"),r=n.filter(s=>{if(!s.dueDate)return!1;const c=(new Date(s.dueDate)-t)/(1e3*60*60*24);return c>=0&&c<=30}),o=n.filter(s=>s.dueDate?new Date(s.dueDate)<t:!1);return{totalPregnant:n.length,dueNextMonth:r.length,overdue:o.length,successRate:B(e)}}catch(e){return console.error("Error calculating breeding stats:",e),{totalPregnant:0,dueNextMonth:0,overdue:0,successRate:0}}}function B(e){const t=e.filter(r=>r.status==="Born"||r.status==="Failed");if(t.length===0)return 0;const n=e.filter(r=>r.status==="Born").length;return Math.round(n/t.length*100)}function Y(){try{const e=m("animals",[]),t=m("treatments",[]);if(!Array.isArray(e)||!Array.isArray(t))return console.warn("Health data not arrays:",typeof e,typeof t),{critical:[],upcoming:[],overdue:[]};const n=new Date,r=new Set;t.forEach(i=>{i.endDate&&new Date(i.endDate)>=n&&r.add(i.animalId)});const o=t.filter(i=>i.nextDue?new Date(i.nextDue)<=n:!1),s=e.filter(i=>{if(!i.lastVaccination)return!0;const c=new Date(i.lastVaccination);return(n-c)/(1e3*60*60*24*30)>=6});return{underTreatment:r.size,dueTreatments:o.length,needsVaccination:s.length,totalAlerts:o.length+s.length}}catch(e){return console.error("Error calculating health alerts:",e),{underTreatment:0,dueTreatments:0,needsVaccination:0,totalAlerts:0}}}function U(){try{const e=m("tasks",[]);if(!Array.isArray(e))return console.warn("Tasks data is not an array:",typeof e),{today:[],thisWeek:[],overdue:[]};const t=new Date,n=e.filter(a=>a.status==="Pending"),r=e.filter(a=>a.status==="In Progress"),o=e.filter(a=>a.status==="Completed"),s=e.filter(a=>a.status==="Completed"||!a.dueDate?!1:new Date(a.dueDate).toDateString()===t.toDateString()),i=new Date(t.getTime()+10080*60*1e3),c=e.filter(a=>{if(a.status==="Completed"||!a.dueDate)return!1;const l=new Date(a.dueDate);return l>t&&l<=i}),d=e.filter(a=>a.status==="Completed"||!a.dueDate?!1:new Date(a.dueDate)<t);return{total:e.length,pending:n.length,inProgress:r.length,completed:o.length,dueToday:s.length,dueThisWeek:c.length,overdue:d.length,completionRate:e.length>0?Math.round(o.length/e.length*100):0}}catch(e){return console.error("Error calculating task stats:",e),{total:0,pending:0,inProgress:0,completed:0,dueToday:0,dueThisWeek:0,overdue:0,completionRate:0}}}function V(e="month"){try{const t=m("transactions",[]);if(!Array.isArray(t))return console.warn("Transactions data is not an array:",typeof t),{income:0,expenses:0,profit:0,transactionCount:0};const n=new Date;let r;switch(e){case"week":r=new Date(n.getTime()-10080*60*1e3);break;case"month":r=new Date(n.getFullYear(),n.getMonth(),1);break;case"year":r=new Date(n.getFullYear(),0,1);break;default:r=new Date(n.getFullYear(),n.getMonth(),1)}const o=t.filter(a=>{const l=new Date(a.date);return l>=r&&l<=n}),s=o.filter(a=>a.type==="Income").reduce((a,l)=>a+(parseFloat(l.amount)||0),0),i=o.filter(a=>a.type==="Expense").reduce((a,l)=>a+(parseFloat(l.amount)||0),0),c=t.filter(a=>a.type==="Income").reduce((a,l)=>a+(parseFloat(l.amount)||0),0),d=t.filter(a=>a.type==="Expense").reduce((a,l)=>a+(parseFloat(l.amount)||0),0);return{period:e,income:s,expenses:i,netProfit:s-i,profitMargin:s>0?Math.round((s-i)/s*100):0,transactionCount:o.length,allTime:{income:c,expenses:d,netProfit:c-d}}}catch(t){return console.error("Error calculating financial summary:",t),{period:e,income:0,expenses:0,netProfit:0,profitMargin:0,transactionCount:0,allTime:{income:0,expenses:0,netProfit:0}}}}function q(e=6){try{const t=m("transactions",[]);if(!Array.isArray(t))return console.warn("Transactions data is not an array:",typeof t),[];const n=new Date,r=t.filter(u=>u.type==="Expense"&&(u.category==="Feed"||u.description&&u.description.toLowerCase().includes("feed"))),o=[];for(let u=e-1;u>=0;u--){const g=new Date(n.getFullYear(),n.getMonth()-u,1),T=new Date(n.getFullYear(),n.getMonth()-u+1,0),k=r.filter(D=>{const f=new Date(D.date);return f>=g&&f<=T}),I=k.reduce((D,f)=>D+(parseFloat(f.amount)||0),0);o.push({month:g.toLocaleDateString("en-US",{month:"short",year:"numeric"}),amount:I,count:k.length})}const s=o.reduce((u,g)=>u+g.amount,0),i=s/e,c=o.slice(0,Math.floor(e/2)),d=o.slice(Math.floor(e/2)),a=c.reduce((u,g)=>u+g.amount,0)/c.length,l=d.reduce((u,g)=>u+g.amount,0)/d.length,p=a>0?Math.round((l-a)/a*100):0;return{monthlyData:o,avgMonthly:i,totalCost:s,trend:p>0?"increasing":p<0?"decreasing":"stable",trendPercent:Math.abs(p)}}catch(t){return console.error("Error calculating feed cost trends:",t),{monthlyData:[],avgMonthly:0,totalCost:0,trend:"stable",trendPercent:0}}}function W(e=10,t=5){try{const n=m("inventory",[]);if(!Array.isArray(n))return console.warn("Inventory data is not an array:",typeof n),{lowStock:[],outOfStock:[],expiringSoon:[]};const r=n.filter(i=>{const c=parseFloat(i.quantity)||0;return c>0&&c<=e&&c>t}),o=n.filter(i=>{const c=parseFloat(i.quantity)||0;return c>0&&c<=t}),s=n.filter(i=>(parseFloat(i.quantity)||0)<=0);return{lowStock:r.length,criticalStock:o.length,outOfStock:s.length,totalAlerts:r.length+o.length+s.length,items:{low:r,critical:o,out:s}}}catch(n){return console.error("Error calculating inventory alerts:",n),{lowStock:0,criticalStock:0,outOfStock:0,totalAlerts:0,items:{low:[],critical:[],out:[]}}}}function _(e="month"){try{const t=m("milkYield",[]);if(!Array.isArray(t))return console.warn("MilkYield data is not an array:",typeof t),{period:e,totalMilk:0,avgDaily:0,producingAnimals:0,recordCount:0};const n=new Date;let r;switch(e){case"week":r=new Date(n.getTime()-10080*60*1e3);break;case"month":r=new Date(n.getFullYear(),n.getMonth(),1);break;case"year":r=new Date(n.getFullYear(),0,1);break;default:r=new Date(n.getFullYear(),n.getMonth(),1)}const o=t.filter(d=>{const a=new Date(d.date);return a>=r&&a<=n}),s=o.reduce((d,a)=>d+(parseFloat(a.amount)||0),0),i=s/Math.max(1,Math.ceil((n-r)/(1e3*60*60*24))),c=new Set(o.map(d=>d.animalId)).size;return{period:e,totalMilk:s,avgDaily:i,producingAnimals:c,recordCount:o.length}}catch(t){return console.error("Error calculating milk production stats:",t),{period:e,totalMilk:0,avgDaily:0,producingAnimals:0,recordCount:0}}}function z(){return{animals:P(),breeding:N(),health:Y(),tasks:U(),finance:V("month"),feedCosts:q(6),inventory:W(),milkProduction:_("month"),lastUpdated:new Date().toISOString()}}export{G as a,K as b,J as c,z as d,H as e,w as g,j as h,L as i,m as l};

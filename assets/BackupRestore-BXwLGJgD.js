import{t as f,A as h,E as S,r as p,j as e}from"./index-B8Dyeey_.js";function y(){return{version:"2.0",timestamp:new Date().toISOString(),animals:JSON.parse(localStorage.getItem("devinsfarm:animals")||"[]"),transactions:JSON.parse(localStorage.getItem("devinsfarm:transactions")||"[]"),inventory:JSON.parse(localStorage.getItem("devinsfarm:inventory")||"[]"),tasks:JSON.parse(localStorage.getItem("devinsfarm:tasks")||"[]"),crops:JSON.parse(localStorage.getItem("devinsfarm:crops")||"[]"),treatments:JSON.parse(localStorage.getItem("devinsfarm:treatments")||"[]"),breeding:JSON.parse(localStorage.getItem("devinsfarm:breeding")||"[]"),feeding:JSON.parse(localStorage.getItem("devinsfarm:feeding")||"[]"),measurements:JSON.parse(localStorage.getItem("devinsfarm:measurements")||"[]"),milkYield:JSON.parse(localStorage.getItem("devinsfarm:milkYield")||"[]"),groups:JSON.parse(localStorage.getItem("devinsfarm:groups")||"[]"),pastures:JSON.parse(localStorage.getItem("devinsfarm:pastures")||"[]"),schedules:JSON.parse(localStorage.getItem("devinsfarm:schedules")||"[]"),equipment:JSON.parse(localStorage.getItem("devinsfarm:equipment")||"[]"),settings:{currency:localStorage.getItem("devinsfarm:currency")||"KES",appSettings:JSON.parse(localStorage.getItem("devinsfarm:app:settings")||"null"),notificationSettings:JSON.parse(localStorage.getItem("devinsfarm:notification:settings")||"null"),uiSettings:JSON.parse(localStorage.getItem("devinsfarm:ui:settings")||"null")},users:JSON.parse(localStorage.getItem("devinsfarm:users")||"[]"),audit:JSON.parse(localStorage.getItem("devinsfarm:audit")||"[]")}}function x(t={}){try{const n=y(),m=t.filename||`devinsfarm-backup-${new Date().toISOString().split("T")[0]}.json`,c=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),r=URL.createObjectURL(c),i=document.createElement("a");return i.href=r,i.download=m,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),f(h.EXPORT,S.OTHER,null,{operation:"Full Backup",filename:m}),{success:!0,filename:m,size:c.size}}catch(n){return console.error("Error creating backup:",n),{success:!1,error:n.message}}}function k(t,n={}){return new Promise((m,c)=>{const r=new FileReader;r.onload=i=>{try{const s=JSON.parse(i.target.result);if(!s.version||!s.timestamp)throw new Error("Invalid backup file format");if(!(n.skipConfirm||confirm(`Restore backup from ${new Date(s.timestamp).toLocaleString()}?

This will ${n.merge?"merge":"replace"} your current data.

Animals: ${s.animals?.length||0}
Transactions: ${s.transactions?.length||0}
Tasks: ${s.tasks?.length||0}
Inventory: ${s.inventory?.length||0}

Are you sure?`))){m({success:!1,cancelled:!0});return}n.createBackupFirst!==!1&&x({filename:`pre-restore-backup-${Date.now()}.json`});const a={};n.merge?(a.animals=d("devinsfarm:animals",s.animals),a.transactions=d("devinsfarm:transactions",s.transactions),a.inventory=d("devinsfarm:inventory",s.inventory),a.tasks=d("devinsfarm:tasks",s.tasks),a.crops=d("devinsfarm:crops",s.crops),a.treatments=d("devinsfarm:treatments",s.treatments),a.breeding=d("devinsfarm:breeding",s.breeding),a.feeding=d("devinsfarm:feeding",s.feeding),a.measurements=d("devinsfarm:measurements",s.measurements),a.milkYield=d("devinsfarm:milkYield",s.milkYield),a.groups=d("devinsfarm:groups",s.groups),a.pastures=d("devinsfarm:pastures",s.pastures),a.schedules=d("devinsfarm:schedules",s.schedules),a.equipment=d("devinsfarm:equipment",s.equipment)):(localStorage.setItem("devinsfarm:animals",JSON.stringify(s.animals||[])),localStorage.setItem("devinsfarm:transactions",JSON.stringify(s.transactions||[])),localStorage.setItem("devinsfarm:inventory",JSON.stringify(s.inventory||[])),localStorage.setItem("devinsfarm:tasks",JSON.stringify(s.tasks||[])),localStorage.setItem("devinsfarm:crops",JSON.stringify(s.crops||[])),localStorage.setItem("devinsfarm:treatments",JSON.stringify(s.treatments||[])),localStorage.setItem("devinsfarm:breeding",JSON.stringify(s.breeding||[])),localStorage.setItem("devinsfarm:feeding",JSON.stringify(s.feeding||[])),localStorage.setItem("devinsfarm:measurements",JSON.stringify(s.measurements||[])),localStorage.setItem("devinsfarm:milkYield",JSON.stringify(s.milkYield||[])),localStorage.setItem("devinsfarm:groups",JSON.stringify(s.groups||[])),localStorage.setItem("devinsfarm:pastures",JSON.stringify(s.pastures||[])),localStorage.setItem("devinsfarm:schedules",JSON.stringify(s.schedules||[])),localStorage.setItem("devinsfarm:equipment",JSON.stringify(s.equipment||[])),a.animals=s.animals?.length||0,a.transactions=s.transactions?.length||0,a.inventory=s.inventory?.length||0,a.tasks=s.tasks?.length||0),s.settings&&(s.settings.currency&&localStorage.setItem("devinsfarm:currency",s.settings.currency),s.settings.appSettings&&localStorage.setItem("devinsfarm:app:settings",JSON.stringify(s.settings.appSettings)),s.settings.notificationSettings&&localStorage.setItem("devinsfarm:notification:settings",JSON.stringify(s.settings.notificationSettings)),s.settings.uiSettings&&localStorage.setItem("devinsfarm:ui:settings",JSON.stringify(s.settings.uiSettings))),n.restoreUsers&&s.users&&localStorage.setItem("devinsfarm:users",JSON.stringify(s.users)),n.restoreAudit&&s.audit&&localStorage.setItem("devinsfarm:audit",JSON.stringify(s.audit)),f(h.IMPORT,S.OTHER,null,{operation:"Full Restore",mode:n.merge?"merge":"replace",backupDate:s.timestamp}),m({success:!0,restored:a,backupDate:s.timestamp,version:s.version})}catch(s){console.error("Error restoring backup:",s),c({success:!1,error:s.message})}},r.onerror=()=>{c({success:!1,error:"Failed to read file"})},r.readAsText(t)})}function d(t,n){if(!n||!Array.isArray(n))return 0;const c=[...JSON.parse(localStorage.getItem(t)||"[]")];let r=0;return n.forEach(i=>{const s=c.findIndex(o=>o.id===i.id);s===-1?(c.push(i),r++):new Date(i.updatedAt||i.date)>new Date(c[s].updatedAt||c[s].date)&&(c[s]=i)}),localStorage.setItem(t,JSON.stringify(c)),r}function j(){const t=y();return{totalRecords:(t.animals?.length||0)+(t.transactions?.length||0)+(t.inventory?.length||0)+(t.tasks?.length||0)+(t.crops?.length||0)+(t.treatments?.length||0)+(t.breeding?.length||0),animals:t.animals?.length||0,transactions:t.transactions?.length||0,inventory:t.inventory?.length||0,tasks:t.tasks?.length||0,crops:t.crops?.length||0,treatments:t.treatments?.length||0,breeding:t.breeding?.length||0,lastBackup:localStorage.getItem("devinsfarm:lastBackup")||null}}function I(){const t=localStorage.getItem("devinsfarm:lastBackup"),m=JSON.parse(localStorage.getItem("devinsfarm:app:settings")||"{}").backupFrequency||7;if(!t)return{needsBackup:!0,daysSince:null,message:"No backup found. Create your first backup now!"};const c=new Date(t),r=Math.floor((Date.now()-c.getTime())/(1e3*60*60*24));return r>=m?{needsBackup:!0,daysSince:r,message:`Last backup was ${r} days ago. Time to create a new backup!`}:{needsBackup:!1,daysSince:r,message:`Last backup: ${r} days ago`}}function O(){localStorage.setItem("devinsfarm:lastBackup",new Date().toISOString())}function B(){const[t,n]=p.useState(null),[m,c]=p.useState(null),[r,i]=p.useState(!1),[s,o]=p.useState(null);p.useEffect(()=>{a(),f(h.VIEW,S.OTHER,null,"Viewed backup/restore")},[]);const a=()=>{const l=j(),g=I();n(l),c(g)},v=async()=>{try{const l=x();l.success?(O(),o({type:"success",text:`âœ… Backup created successfully! File: ${l.filename} (${(l.size/1024).toFixed(2)} KB)`}),a()):o({type:"error",text:`âŒ Backup failed: ${l.error}`})}catch(l){o({type:"error",text:`âŒ Error creating backup: ${l.message}`})}},b=async l=>{const g=l.target.files[0];if(g){i(!0),o({type:"info",text:"â³ Restoring backup..."});try{const u=await k(g,{merge:!1,createBackupFirst:!0,restoreUsers:!1,restoreAudit:!1});u.success?(o({type:"success",text:`âœ… Backup restored successfully! Restored from ${new Date(u.backupDate).toLocaleString()}`}),a(),setTimeout(()=>{confirm("Backup restored! Reload page to see changes?")&&window.location.reload()},2e3)):u.cancelled?o({type:"info",text:"â„¹ï¸ Restore cancelled"}):o({type:"error",text:`âŒ Restore failed: ${u.error}`})}catch(u){o({type:"error",text:`âŒ Error restoring backup: ${u.message}`})}finally{i(!1),l.target.value=""}}},N=async l=>{const g=l.target.files[0];if(g){i(!0),o({type:"info",text:"â³ Merging backup data..."});try{const u=await k(g,{merge:!0,createBackupFirst:!0,restoreUsers:!1,restoreAudit:!1});u.success?(o({type:"success",text:`âœ… Backup merged successfully! Added new records from ${new Date(u.backupDate).toLocaleString()}`}),a(),setTimeout(()=>{confirm("Backup merged! Reload page to see changes?")&&window.location.reload()},2e3)):u.cancelled?o({type:"info",text:"â„¹ï¸ Merge cancelled"}):o({type:"error",text:`âŒ Merge failed: ${u.error}`})}catch(u){o({type:"error",text:`âŒ Error merging backup: ${u.message}`})}finally{i(!1),l.target.value=""}}};return e.jsxs("div",{className:"backup-restore-container",children:[e.jsx("h1",{children:"ğŸ’¾ Backup & Restore"}),s&&e.jsx("div",{className:`message message-${s.type}`,children:s.text}),m?.needsBackup&&e.jsxs("div",{className:"backup-reminder warning",children:[e.jsx("h3",{children:"âš ï¸ Backup Reminder"}),e.jsx("p",{children:m.message}),e.jsx("button",{onClick:v,className:"btn-primary",children:"Create Backup Now"})]}),t&&e.jsxs("div",{className:"backup-stats",children:[e.jsx("h2",{children:"ğŸ“Š Current Data Statistics"}),e.jsxs("div",{className:"stats-grid",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:t.totalRecords}),e.jsx("div",{className:"stat-label",children:"Total Records"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:t.animals}),e.jsx("div",{className:"stat-label",children:"Animals"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:t.transactions}),e.jsx("div",{className:"stat-label",children:"Transactions"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:t.tasks}),e.jsx("div",{className:"stat-label",children:"Tasks"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:t.inventory}),e.jsx("div",{className:"stat-label",children:"Inventory Items"})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("div",{className:"stat-value",children:t.treatments}),e.jsx("div",{className:"stat-label",children:"Treatments"})]})]}),t.lastBackup&&e.jsxs("p",{className:"last-backup",children:["Last backup: ",new Date(t.lastBackup).toLocaleString(),"(",m?.daysSince," days ago)"]})]}),e.jsxs("div",{className:"backup-section",children:[e.jsx("h2",{children:"ğŸ“¦ Create Backup"}),e.jsx("p",{children:"Download a complete backup of all your farm data to a JSON file."}),e.jsxs("div",{className:"backup-info",children:[e.jsx("h4",{children:"What's included in the backup:"}),e.jsxs("ul",{children:[e.jsx("li",{children:"âœ… All animal records and history"}),e.jsx("li",{children:"âœ… Financial transactions"}),e.jsx("li",{children:"âœ… Inventory items"}),e.jsx("li",{children:"âœ… Tasks and schedules"}),e.jsx("li",{children:"âœ… Crops and yields"}),e.jsx("li",{children:"âœ… Treatments and breeding records"}),e.jsx("li",{children:"âœ… Feed records and measurements"}),e.jsx("li",{children:"âœ… Groups, pastures, and equipment"}),e.jsx("li",{children:"âœ… All settings and preferences"})]})]}),e.jsx("button",{onClick:v,className:"btn-backup",children:"ğŸ“¥ Download Backup File"})]}),e.jsxs("div",{className:"restore-section",children:[e.jsx("h2",{children:"â™»ï¸ Restore from Backup"}),e.jsx("p",{children:"Restore your data from a previously created backup file."}),e.jsxs("div",{className:"restore-options",children:[e.jsxs("div",{className:"restore-option",children:[e.jsx("h3",{children:"ğŸ”„ Replace All Data"}),e.jsxs("p",{children:["âš ï¸ This will ",e.jsx("strong",{children:"delete all current data"})," and replace it with the backup."]}),e.jsx("p",{children:"A safety backup of your current data will be created first."}),e.jsxs("label",{className:"file-input-label",children:[e.jsx("input",{type:"file",accept:".json",onChange:b,disabled:r,style:{display:"none"}}),e.jsx("button",{className:"btn-restore",disabled:r,onClick:l=>l.currentTarget.previousElementSibling.click(),children:r?"â³ Restoring...":"ğŸ“¤ Choose Backup File to Restore"})]})]}),e.jsxs("div",{className:"restore-option",children:[e.jsx("h3",{children:"â• Merge with Current Data"}),e.jsx("p",{children:"Add new records from backup without deleting current data."}),e.jsx("p",{children:"Existing records with the same ID will be kept (no overwrite)."}),e.jsxs("label",{className:"file-input-label",children:[e.jsx("input",{type:"file",accept:".json",onChange:N,disabled:r,style:{display:"none"}}),e.jsx("button",{className:"btn-merge",disabled:r,onClick:l=>l.currentTarget.previousElementSibling.click(),children:r?"â³ Merging...":"ğŸ”€ Choose Backup File to Merge"})]})]})]})]}),e.jsxs("div",{className:"backup-best-practices",children:[e.jsx("h2",{children:"ğŸ’¡ Backup Best Practices"}),e.jsxs("ul",{children:[e.jsx("li",{children:"ğŸ—“ï¸ Create regular backups (weekly recommended)"}),e.jsx("li",{children:"ğŸ’¾ Store backup files in multiple locations (external drive, cloud storage)"}),e.jsx("li",{children:"ğŸ“… Name backups with dates for easy identification"}),e.jsx("li",{children:"ğŸ§ª Test restore process occasionally to ensure backups work"}),e.jsx("li",{children:"ğŸ” Keep backups secure (they contain sensitive farm data)"}),e.jsx("li",{children:"ğŸ“Š Create backups before major data imports or changes"})]})]})]})}export{B as default};
